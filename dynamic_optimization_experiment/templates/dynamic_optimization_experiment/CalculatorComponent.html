{% load otree %}

<div class="card bg-light m-3">
  <div class="card-body">
    <h2 style="text-align: center;">
        Budgeting Calculator
    </h2>
    <br/>

    <style>
      table,
      td {
          border: 1px solid #333;
      }
      
      thead,
      tfoot {
          background-color: #333;
          color: #fff;
      }
    </style>

    <!-- no way this is best practice -->
    <div style="display: none;">
      <div id="constants_income">
        {{Constants.income}}
      </div>
      <div id="constants_price_per_unit">
        {{Constants.price_per_unit}}
      </div>
      <div id="constants_interest_rate">
        {{Constants.interest_rate}}
      </div>
      <div id="constants_num_rounds">
        {{Constants.num_rounds}}
      </div>
      <div id="constants_k_payoff">
        {{Constants.k_payoff}}
      </div>
    </div>

    <table id="myTable" style="text-align: center;">
      <tbody id="table_body">
        <tr style="background-color:chartreuse;">
          <td>Period</td>
          <td>Income (Tokens)</td>
          <td>Price per Unit</td>
          <td>Interest Rate (%)</td>
          <td>Token Balance (beginning of the period)</td>
          <td>Purchased Units</td>
          <td>Points</td>
          <td>AccumulatedPoints</td>
          <td>Final Tokens Balance</td>
        </tr>
      </tbody>
    </table>

    <br/>
    <div style="text-align: center;">
      <button onClick=resetEntireTable(event)>Reset values</button>
      <button style="background-color: red;"onClick=calcHypotheticalRow(event)>Calculate</button>
    </div>

    <script>
      //calculates token balance
      //input is period and any calculated interest which is an integer and is simply added 
      function calculateTokenBalance(num,interest=0){
        let outputCellData = document.createElement('td');
        outputCellData.id = `token-balance-${num}`
        if ( num === 1 ) {
          outputCellData.innerHTML = constantsIncome
        } else {
          let tokenBalanceFromLastRound = document.getElementById(`final-token-balance-${num-1}`);
          
          if ( tokenBalanceFromLastRound ) {
            outputCellData.innerHTML = Number(tokenBalanceFromLastRound.innerHTML)+Number(constantsIncome)+interest;
          }
          
        }
        return outputCellData;
      }

      //calculates interest based on the period
      //finds the most recent final token balance,
      //calculates interested paid /owed
      //then returns that integer value
      function calculateInterestOnLastRoundsFinalTokenBalance(num){
        if ( num >= js_vars.player_round_number ) {
          console.log('num>>',num);
        }

        let tokenBalanceFromLastRound = document.getElementById(`final-token-balance-${num-1}`).innerHTML;

        return tokenBalanceFromLastRound*(constantsInterestRate*.01);
      }

      //
      function findPurchasedUnitsByPeriod(num,arr){
        let outputCellData = document.createElement('td');

        if ( arr[num-1] ){
          outputCellData.innerHTML = arr[num-1];
        }

        return outputCellData;
      }

      //calculate the points earned in a given round
      function calculatePointsEarned(unitsPurchased,constant){
        let outputCellData = document.createElement('td');
        outputCellData.innerHTML = (constant * ( unitsPurchased**0.5 )).toFixed(2);

        return outputCellData;
      }

      //calculate the total points earned up to that round
      function calculateAccumulatedPointsByPeriod(num,pointsJustEarned=0){
        if ( num >= js_vars.player_round_number ) {
          console.log('calculateAccumulatedPointsByPeriod this is num>>',num);
          console.log('calculateAccumulatedPointsByPeriod this is pointsJustEarned>>',pointsJustEarned);
        }
        let outputCellData = document.createElement('td');

        if ( num === 1 ) {
          outputCellData.innerText = pointsJustEarned;
        } else {
          let finalTokenBalanceFromLastRound = document.getElementById(`total-points-${num-1}`);
          outputCellData.innerHTML = (Number(finalTokenBalanceFromLastRound.innerHTML)+Number(pointsJustEarned)).toFixed(2);
        }

        return outputCellData
      }

      function calculateFinalTokenBalance(num,tokenBalance,pricePerUnit,unitsPurchased){
        let outputCellData = document.createElement('td');

        if ( num === 1 ) {
          outputCellData.innerHTML = Number(tokenBalance) - Number(pricePerUnit) * Number(unitsPurchased) ;
        } else {
          outputCellData.innerHTML = (Number(tokenBalance) - Number(pricePerUnit) * Number(unitsPurchased)).toFixed(2) ;
        }

        return outputCellData;
      }
      
      console.log(js_vars);
      let myTable = document.getElementById("myTable");

      //get a string (innerHTML) from a particular element, then remove all non-numerical values
      let constantsIncome = document.getElementById("constants_income").innerHTML.trim(); 
      let incomeCellData = document.createElement('td');
      incomeCellData.innerHTML = constantsIncome;

      let constantsPricePerUnit = document.getElementById("constants_price_per_unit").innerHTML.trim(); 
      let pricePerUnitCellData = document.createElement('td');
      pricePerUnitCellData.innerHTML = constantsPricePerUnit;

      let constantsInterestRate = document.getElementById("constants_interest_rate").innerHTML.trim(); 
      let interestRateCellData = document.createElement('td');
      interestRateCellData.innerHTML = constantsInterestRate;

      let constantsNumberOfRounds = document.getElementById("constants_num_rounds").innerHTML.trim()

      let constantsKPayoff = document.getElementById("constants_k_payoff").innerHTML.trim()

      //populate periods in the past
      for ( let i = 0; i < js_vars.player_round_number-1; i++ ) {
        let newRow = document.createElement('tr');
        newRow.style.cssText = "background-color:white"
        
        let period = i+1;
        let periodCellData = document.createElement('td');
        periodCellData.innerText = period;
        
        newRow.id = `row-period-${period}`

        let incomeClone = incomeCellData.cloneNode(true);
        let pricePerUnitClone = pricePerUnitCellData.cloneNode(true);
        let interestRateClone = interestRateCellData.cloneNode(true);
        
        let interestToBeAdded = (period > 1) ? calculateInterestOnLastRoundsFinalTokenBalance(period) : 0;
        
        let tokenBalanceCellData = calculateTokenBalance(period,interestToBeAdded);
        tokenBalanceCellData.id = `token-balance-${period}`

        let purchasedUnitsCellData = findPurchasedUnitsByPeriod(period,js_vars.purchased_units_across_all_rounds);
        purchasedUnitsCellData.id = `purchased-units-${period}`;

        let pointsEarnedCellData = calculatePointsEarned(purchasedUnitsCellData.innerHTML,constantsKPayoff);
        pointsEarnedCellData.id = `points-data-${period}`

        newRow.appendChild(periodCellData);
        newRow.appendChild(incomeClone);
        newRow.appendChild(pricePerUnitClone);
        newRow.appendChild(interestRateClone)

        //is this logic really necessary?
        if ( tokenBalanceCellData ) {
          newRow.appendChild(tokenBalanceCellData);
        }

        if ( purchasedUnitsCellData ) {
          newRow.appendChild(purchasedUnitsCellData);
        }

        let accumulatedPointsCellData = calculateAccumulatedPointsByPeriod(period,pointsEarnedCellData.innerHTML);
        accumulatedPointsCellData.id = `total-points-${period}`;

        let finalTokenBalanceCellData = 
          calculateFinalTokenBalance(period,tokenBalanceCellData.innerHTML,constantsPricePerUnit,purchasedUnitsCellData.innerHTML)
        finalTokenBalanceCellData.id = `final-token-balance-${period}`;

        newRow.appendChild(pointsEarnedCellData);
        newRow.appendChild(accumulatedPointsCellData);
        newRow.appendChild(finalTokenBalanceCellData);

        myTable.appendChild(newRow);
      };


      //populate current and future rounds
      for ( let i = js_vars.player_round_number-1; i < constantsNumberOfRounds; i++ ) {
        let newRow = document.createElement('tr');
        newRow.style.cssText = (i===js_vars.player_round_number-1) ? "background-color:yellow" : "background-color:#c6c6c6"

        let period = i+1;
        let periodCellData = document.createElement('td');
        periodCellData.innerText = period;

        newRow.id = `row-period-${period}`

        let incomeClone = incomeCellData.cloneNode(true);
        let pricePerUnitClone = pricePerUnitCellData.cloneNode(true);
        let interestRateClone = interestRateCellData.cloneNode(true);
        
        //only calculate interest for the preceeding round
        let interestToBeAdded = (i === js_vars.player_round_number-1) ? calculateInterestOnLastRoundsFinalTokenBalance(period) : 0;
        
        let tokenBalanceCellData = calculateTokenBalance(period,interestToBeAdded);

        let purchasedUnitsCellData = document.createElement('input');
        purchasedUnitsCellData.type = "number";
        purchasedUnitsCellData.min = 0;
        purchasedUnitsCellData.id = `purchased-unit-input-${period}`;
        purchasedUnitsCellData.style.cssText = "background-color:#ffbbff;text-align:center";

        newRow.appendChild(periodCellData);
        newRow.appendChild(incomeClone);
        newRow.appendChild(pricePerUnitClone);
        newRow.appendChild(interestRateClone);
        newRow.appendChild(tokenBalanceCellData);
        newRow.appendChild(purchasedUnitsCellData);

        //append token balance
        myTable.appendChild(newRow);
      }
    </script>

    <!-- button functions -->
    <script>
      //while false, functions will try to append elements to the table
      //while true, functions will try to overwrite table data's innerHTML
      let calculateButtonWasUsed = false;

      //resets values in the row (technically as a side effect)
      function resetEntireTable(event){
        event.preventDefault();
        let currRow = document.getElementById(`row-period-${js_vars.player_round_number}`);
        // let allHypotheticals = document.getElementsByClassName('hypothetical');

        for ( let i = js_vars.player_round_number; i <= Number(constantsNumberOfRounds);  i++ ) {
          let pointsTableDataElem = document.getElementById(`points-data-${i}`)
          let totalPointsTableDataElem = document.getElementById(`total-points-${i}`)
          let finalTokensBalanceTableDataElem = document.getElementById(`final-token-balance-${i}`)
          
          if ( i < Number(constantsNumberOfRounds) ) {
            let nextBeginningTokensBalanceTableDataElem = document.getElementById(`token-balance-${i+1}`) 
            nextBeginningTokensBalanceTableDataElem.innerHTML = '';
          }

          console.log(pointsTableDataElem)
          console.log(totalPointsTableDataElem)
          console.log(finalTokensBalanceTableDataElem)
          
          pointsTableDataElem.innerHTML = '';
          finalTokensBalanceTableDataElem.innerHTML = '';
          totalPointsTableDataElem.innerHTML = '';
        }
      }

      //calculate what values should be inputted
      //then call separate function to append those values
      function calcHypotheticalRow(event){
        event.preventDefault();

        let beginningTokenBalance = Number(document.getElementById(`token-balance-${js_vars.player_round_number}`).innerHTML);
        let beginningTotalPoints = Number(document.getElementById(`total-points-${js_vars.player_round_number-1}`).innerHTML);
        
        let purchasedUnitInput = Number(document.getElementById(`purchased-unit-input-${js_vars.player_round_number}`).value);
        let hypotheticalPointGain = calcPointGain(purchasedUnitInput,Number(constantsKPayoff))
        let hypotheticalFinalTokenBalance = beginningTokenBalance - (purchasedUnitInput*constantsPricePerUnit)
        
        return updateCurrentRow(hypotheticalPointGain,
                                  beginningTotalPoints+hypotheticalPointGain,
                                  hypotheticalFinalTokenBalance)
          .then((startUpdatingAtThisRow)=>{
            // for ( let i = startUpdatingAtThisRow; i <= 4; i++ ) {
            for ( let i = startUpdatingAtThisRow; i <= Number(constantsNumberOfRounds); i++ ) {
              updateFutureRowByPeriod(i);
            }

            calculateButtonWasUsed = true;

            return 'everything worked';

          }).catch((err)=>{
            return console.error(`this  is your err: ${err}`);
          });
      }

      async function updateFutureRowByPeriod(periodNumber){
        let latestFinalTokenBalance = Number(document.getElementById(`final-token-balance-${periodNumber-1}`).innerHTML);
        let income = Number(constantsIncome);
        let mostRecentPointTotal = Number(document.getElementById(`total-points-${periodNumber-1}`).innerHTML);
        let interestToBeAdded = Number((latestFinalTokenBalance*Number(constantsInterestRate)*.01).toFixed(2));
        let futureTokenStartingBalance =  Number((latestFinalTokenBalance+interestToBeAdded).toFixed(2))+income;
        let futurePurchasedUnits = Number(document.getElementById(`purchased-unit-input-${periodNumber}`).value);
        let hypotheticalPointsGained = Number((calcPointGain(futurePurchasedUnits,Number(constantsKPayoff))).toFixed(2));
        let hypotheticalCostOfUnitsPurchased = futurePurchasedUnits*Number(constantsPricePerUnit);

        let currRow = document.getElementById(`row-period-${periodNumber}`);
        
        let futureTokenStartingBalanceTableDataElem = document.getElementById(`token-balance-${periodNumber}`);
        futureTokenStartingBalanceTableDataElem.innerHTML = futureTokenStartingBalance.toFixed(2);
        
        if ( !calculateButtonWasUsed ) {
          //update future token balance
          let futurePointsGainedTableDataElem = document.createElement('td');
          futurePointsGainedTableDataElem.id = `points-data-${periodNumber}`;
          futurePointsGainedTableDataElem.innerHTML = hypotheticalPointsGained;
          
          let futureTotalPointsTableDataElem = document.createElement('td');
          futureTotalPointsTableDataElem.id = `total-points-${periodNumber}`;
          futureTotalPointsTableDataElem.innerHTML = Number((mostRecentPointTotal + hypotheticalPointsGained).toFixed(2));
          
          let futureFinalTokensBalanceTableDataElem = document.createElement('td');
          futureFinalTokensBalanceTableDataElem.id = `final-token-balance-${periodNumber}`;
          futureFinalTokensBalanceTableDataElem.innerHTML = Number((futureTokenStartingBalance - hypotheticalCostOfUnitsPurchased).toFixed(2));

          currRow.appendChild(futurePointsGainedTableDataElem);
          currRow.appendChild(futureTotalPointsTableDataElem);
          currRow.appendChild(futureFinalTokensBalanceTableDataElem);
        } else {
          let futurePointsGainedTableDataElem = document.getElementById(`points-data-${periodNumber}`);
          futurePointsGainedTableDataElem.innerHTML = hypotheticalPointsGained.toFixed(2);
          
          let futureTotalPointsTableDataElem = document.getElementById(`total-points-${periodNumber}`);
          futureTotalPointsTableDataElem.innerHTML = Number((mostRecentPointTotal + hypotheticalPointsGained).toFixed(2));
          
          let futureFinalTokensBalanceTableDataElem = document.getElementById(`final-token-balance-${periodNumber}`);
          futureFinalTokensBalanceTableDataElem.innerHTML = Number((futureTokenStartingBalance - hypotheticalCostOfUnitsPurchased).toFixed(2));
        }
      }

      //appends input values to current row
      // create table data elements. give appropriate labels, and round where necessary
      // these points, total points, and final token balance 
      async function updateCurrentRow(pointsScored,totalPoints,finalTokenBalance){
        let currRow = document.getElementById(`row-period-${js_vars.player_round_number}`);

        if ( !calculateButtonWasUsed )  {
          let pointsTableDataElem = document.createElement('td');
          pointsTableDataElem.id = `points-data-${js_vars.player_round_number}`;
          pointsTableDataElem.innerHTML = pointsScored.toFixed(2);
          
          let totalPointsTableDataElem = document.createElement('td');
          totalPointsTableDataElem.id = `total-points-${js_vars.player_round_number}`;
          totalPointsTableDataElem.innerHTML = totalPoints.toFixed(2);
          
          let finalTokenBalanceTableDataElem = document.createElement('td');
          finalTokenBalanceTableDataElem.id = `final-token-balance-${js_vars.player_round_number}`;
          finalTokenBalanceTableDataElem.innerHTML = finalTokenBalance.toFixed(2);
          
          currRow.appendChild(pointsTableDataElem);
          currRow.appendChild(totalPointsTableDataElem);
          currRow.appendChild(finalTokenBalanceTableDataElem);
        } else {
          let  pointsTableDataElem = document.getElementById(`points-data-${js_vars.player_round_number}`)
          let  totalPointsTableDataElem = document.getElementById(`total-points-${js_vars.player_round_number}`)
          let  finalTokenBalanceTableDataElem = document.getElementById(`final-token-balance-${js_vars.player_round_number}`)
          
          finalTokenBalanceTableDataElem.innerHTML = finalTokenBalance.toFixed(2);
          pointsTableDataElem.innerHTML = pointsScored.toFixed(2);
          totalPointsTableDataElem.innerHTML = totalPoints.toFixed(2);
        }

        return js_vars.player_round_number+1;
      }

      //here is the function used to calculate points gained from units of output
      function calcPointGain(output,kPayoffConstant){
        return (kPayoffConstant*(output**2))+5 
      }

    </script>

  </div>
</div>