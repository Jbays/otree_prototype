{% load otree %}

<div class="card bg-light m-3">
  <div class="card-body decision-box" style="padding-bottom: 20px;">
    <div class="titleContainer">
      <div class="flexContainer">
        <div class="titleDash"></div>
        <div class="title">
          Budgeting Calculator
        </div>
      </div>
    </div>

    <style>
      button {
        min-width: 120px;
      }

      table,
      td {
        border: 1px solid #272d38;
      }

      tr:nth-child(even) {
        background-color: #343c4a;
      }

      thead,
      tfoot {
        background-color: #272d38;
        color: #fff;
      }

      .m-3 {
        margin: 1.5rem 0 0 0 !important
      }

      .red-button:hover {
        box-shadow: 0px 0px 0px 3px rgba(96, 255, 95, 0.3) !important;
      }

      #myTable {
        text-align: center;
        margin: 0 auto 1.25rem auto;
        width: 100%;
      }
    </style>

    <table id="myTable">
      <tbody style="text-align: center;" id="table_body">
      </tbody>
    </table>

    <div style="text-align: center;">
      <button class="red-button" style="background-color: white !important; color: #23272f !important; border-color: white !important;" onClick=handleResetClick(event)>
        Reset Values
      </button>
      <button onClick=handleCalculateClick(event)>Calculate</button>
    </div>

    <div id="total_number_of_periods_container" style="display:none">{{Constants.num_rounds}}</div>
    <!-- handles collecting all inputs made to calculator -->
    <script>
      // let allInputsMadeInCalculator = document.getElementById('id_all_inputs_made_in_calculator');
      // allInputsMadeInCalculator.value = "-";
    </script>

    <!-- calculator methods and helper methods-->
    <script>
      function calculateNaturalLogVals(num){
        if ( num <= 1 ) {
          return 0
        }
        return  Math.log(num) / Math.log(Math.E);
      }
      // current period across all rounds is standard
      const currentPeriod = js_vars.current_period_across_all_rounds[0];
      let isFirstPeriodInTreatment = currentPeriod % 3 === 1;
      let isSecondPeriodInTreatment = currentPeriod % 3 === 2;
      let isThirdPeriodInTreatment = currentPeriod % 3 === 0;
      
      const costPerUnitFirstPeriod = js_vars.cost_per_unit_across_all_rounds[0];
      const costPerUnitSecondPeriod = js_vars.cost_per_unit_across_all_rounds[1];
      const costPerUnitThirdPeriod = js_vars.cost_per_unit_across_all_rounds[2];
      let interestRate = js_vars.interest_rate_across_all_rounds[0];

      // const incomeFirstPeriod = js_vars.income_across_all_rounds[0];
      // const incomeSecondPeriod = js_vars.income_across_all_rounds[1];
      const incomeThirdPeriod = js_vars.income_across_all_rounds[2];

      if (interestRate < 0) {
        interestRate = interestRate + 1;
      }

      // console.log('js_vars',js_vars);

      let resetTableNeeded = false;

      function handleCalculateClick(event){
        if (event) {
          event.preventDefault();
        }

        if (resetTableNeeded){
          handleResetClick();
        }
        let startTokenBalanceFirstPeriodElem = document.getElementById('start_token_balance-1');
        let startTokenBalanceSecondPeriodElem = document.getElementById('start_token_balance-2');
        let startTokenBalanceThirdPeriodElem = document.getElementById('start_token_balance-3');

        let purchasedUnitsInputFirstPeriod = document.getElementById(`purchased_unit-1`);
        let purchasedUnitsInputSecondPeriod = document.getElementById(`purchased_unit-2`);
        let purchasedUnitsInputThirdPeriod = document.getElementById(`purchased_unit-3`);
        
        let pointsFirstPeriodElem = document.getElementById('points-1');
        let pointsSecondPeriodElem = document.getElementById('points-2');
        let pointsThirdPeriodElem = document.getElementById('points-3');

        let pointsScoredFirstPeriod;
        let pointsScoredSecondPeriod;
        let pointsScoredThirdPeriod;

        let totalPointsFirstPeriodElem = document.getElementById('total_points-1');
        let totalPointsSecondPeriodElem = document.getElementById('total_points-2');
        let totalPointsThirdPeriodElem = document.getElementById('total_points-3');

        let finalTokenBalanceFirstPeriodElem = document.getElementById('final_token_balance-1');
        let finalTokenBalanceSecondPeriodElem = document.getElementById('final_token_balance-2');
        let finalTokenBalanceThirdPeriodElem = document.getElementById('final_token_balance-3');

        // 1 NOV 2022 -- NOTE: LOTS OF DUPLICATED LOGIC / VARIABLES HERE!
        // if its the first period, then FOR PERIOD 1 --> update points, total points, final token balance,
        if (isFirstPeriodInTreatment) {
          const startTokenBalanceFirstPeriod = Number(startTokenBalanceFirstPeriodElem.innerText);
          const purchasedUnitFirstPeriod = Number(purchasedUnitsInputFirstPeriod.value);
          pointsScoredFirstPeriod = Number((calculateNaturalLogVals(purchasedUnitFirstPeriod)).toFixed(2));
          pointsFirstPeriodElem.innerText = pointsScoredFirstPeriod;
          totalPointsFirstPeriodElem.innerText = pointsScoredFirstPeriod;
          const totalCostFirstPeriod = costPerUnitFirstPeriod * purchasedUnitFirstPeriod;
          finalTokenBalanceFirstPeriodElem.innerText = startTokenBalanceFirstPeriod - totalCostFirstPeriod;
          
          const startTokenBalanceSecondPeriod = Number(startTokenBalanceSecondPeriodElem.innerText);
          startTokenBalanceSecondPeriodElem.innerText = (startTokenBalanceSecondPeriod - totalCostFirstPeriod) * interestRate;
          const purchasedUnitSecondPeriod = Number(purchasedUnitsInputSecondPeriod.value);
          pointsScoredSecondPeriod = Number((calculateNaturalLogVals(purchasedUnitSecondPeriod)).toFixed(2));
          pointsSecondPeriodElem.innerText = pointsScoredSecondPeriod;
          totalPointsSecondPeriodElem.innerText = pointsScoredFirstPeriod + pointsScoredSecondPeriod;
          const totalCostSecondPeriod = costPerUnitSecondPeriod * purchasedUnitSecondPeriod;
          finalTokenBalanceSecondPeriodElem.innerText = startTokenBalanceSecondPeriodElem.innerText - totalCostSecondPeriod;

          const startTokenBalanceThirdPeriod = Number(startTokenBalanceThirdPeriodElem.innerText);
          startTokenBalanceThirdPeriodElem.innerText = (finalTokenBalanceSecondPeriodElem.innerText * interestRate) + incomeThirdPeriod;
          // startTokenBalanceThirdPeriodElem.innerText = (startTokenBalanceThirdPeriod - totalCostFirstPeriod - totalCostSecondPeriod) * interestRate;
          const purchasedUnitThirdPeriod = Number(purchasedUnitsInputThirdPeriod.value);
          pointsScoredThirdPeriod = Number((calculateNaturalLogVals(purchasedUnitThirdPeriod)).toFixed(2));
          pointsThirdPeriodElem.innerText = pointsScoredThirdPeriod;
          const totalCostThirdPeriod = costPerUnitThirdPeriod * purchasedUnitThirdPeriod;
          totalPointsThirdPeriodElem.innerText = (pointsScoredFirstPeriod + pointsScoredSecondPeriod + pointsScoredThirdPeriod).toFixed(2);
          const finalTokenBalanceThirdPeriod = startTokenBalanceThirdPeriod - totalCostFirstPeriod - totalCostSecondPeriod - totalCostThirdPeriod;
          finalTokenBalanceThirdPeriodElem.innerText = finalTokenBalanceThirdPeriod;
        } else if (isSecondPeriodInTreatment) {
          pointsScoredFirstPeriod = Number(pointsFirstPeriodElem.innerText);

          const startTokenBalanceSecondPeriod = Number(startTokenBalanceSecondPeriodElem.innerText);
          const purchasedUnitSecondPeriod = Number(purchasedUnitsInputSecondPeriod.value);
          pointsScoredSecondPeriod = Number((calculateNaturalLogVals(purchasedUnitSecondPeriod)).toFixed(2));
          pointsSecondPeriodElem.innerText = pointsScoredSecondPeriod;
          totalPointsSecondPeriodElem.innerText = Number(pointsScoredFirstPeriod) + Number(pointsScoredSecondPeriod);
          const totalCostSecondPeriod = costPerUnitSecondPeriod * purchasedUnitSecondPeriod;
          finalTokenBalanceSecondPeriodElem.innerText = startTokenBalanceSecondPeriod - totalCostSecondPeriod;

          const startTokenBalanceThirdPeriod = Number(startTokenBalanceThirdPeriodElem.innerText);
          startTokenBalanceThirdPeriodElem.innerText = startTokenBalanceThirdPeriod;
          const purchasedUnitThirdPeriod = Number(purchasedUnitsInputThirdPeriod.value);
          pointsScoredThirdPeriod = Number((calculateNaturalLogVals(purchasedUnitThirdPeriod)).toFixed(2));
          pointsThirdPeriodElem.innerText = pointsScoredThirdPeriod;
          const totalCostThirdPeriod = costPerUnitThirdPeriod * purchasedUnitThirdPeriod;
          totalPointsThirdPeriodElem.innerText = (pointsScoredFirstPeriod + pointsScoredSecondPeriod + pointsScoredThirdPeriod).toFixed(2);
          const finalTokenBalanceThirdPeriod = startTokenBalanceThirdPeriod - totalCostThirdPeriod;
          finalTokenBalanceThirdPeriodElem.innerText = finalTokenBalanceThirdPeriod;
        } else if (isThirdPeriodInTreatment){
          pointsScoredFirstPeriod = Number(pointsFirstPeriodElem.innerText);
          pointsScoredSecondPeriod = Number(pointsSecondPeriodElem.innerText);

          const startTokenBalanceThirdPeriod = Number(startTokenBalanceThirdPeriodElem.innerText);
          const purchasedUnitThirdPeriod = Number(purchasedUnitsInputThirdPeriod.value);
          pointsScoredThirdPeriod = Number((calculateNaturalLogVals(purchasedUnitThirdPeriod)).toFixed(2));
          pointsThirdPeriodElem.innerText = pointsScoredThirdPeriod;
          const totalCostThirdPeriod = costPerUnitThirdPeriod * purchasedUnitThirdPeriod;
          totalPointsThirdPeriodElem.innerText = (pointsScoredFirstPeriod + pointsScoredSecondPeriod + pointsScoredThirdPeriod).toFixed(2);
          const finalTokenBalanceThirdPeriod = startTokenBalanceThirdPeriod - totalCostThirdPeriod;
          finalTokenBalanceThirdPeriodElem.innerText = finalTokenBalanceThirdPeriod;
        }

        resetTableNeeded = true;
      }

      function handleResetClick(event){
        if (event){
          event.preventDefault();
        }
        let calculatorTable = document.getElementById('myTable');
        const tableBody = calculatorTable.getElementsByTagName('tbody')[0];
        calculatorTable.removeChild(tableBody);
        const defaultTableBodyClone = DEFAULT_VAL_TABLE_BODY.cloneNode(true);
        calculatorTable.appendChild(defaultTableBodyClone);
        resetTableNeeded = false;
      }
    </script>

    <script>
      const PERIODS_PER_TREATMENT = 3;
      const CALCULATOR_COLUMN_NAMES = ['period', 'income', 'inflation', 'cost_per_unit', 'interest_rate', 'start_token_balance', 'purchased_unit', 'points', 'total_points', 'final_token_balance'];
      const BUDGET_CALCULATOR_CLONE = document.getElementById('myTable').cloneNode(true);

      const MAP_BACKEND_LABELS_TO_JS_VAR_LABELS = {
        'period': 'period_across_all_rounds',
        'income': 'income_across_all_rounds',
        'inflation': 'inflation_across_all_rounds',
        'cost_per_unit': 'cost_per_unit_across_all_rounds',
        'interest_rate': 'interest_rate_across_all_rounds',
        'start_token_balance': 'start_token_balance_across_all_rounds',
        'purchased_unit': 'purchased_unit_across_all_rounds',
        'points': 'points_across_all_rounds',
        'total_points': 'total_points_across_all_rounds',
        'final_token_balance': 'final_token_balance_across_all_rounds',
      };

      let budgetingCalculatorBody = document.getElementById('table_body');
  
      let defaultPurchasedUnit = document.createElement('input');
      defaultPurchasedUnit.type = "number";
      defaultPurchasedUnit.step = "any";
      defaultPurchasedUnit.min = 0;
      defaultPurchasedUnit.style.cssText = "text-align: center; width: 100%; border-radius: 0 !important; border-bottom: 1px solid #23272f !important;";

      // assembles column labels and appends to table
      function assembleZerothRow(tableBody){
        let columnLabelRow = document.createElement('tr');
        columnLabelRow.id = 'table_row_0';
        CALCULATOR_COLUMN_NAMES.forEach((keyname) => {
          const columnLabel = document.createElement('td');
          columnLabel.id = `${keyname}-0`;
          columnLabel.innerText = keyname;
          columnLabelRow.append(columnLabel);
        })
        tableBody.append(columnLabelRow);
      }

      // the sequence required to render the table correct:
      // period, income, inflation,
      // cost per unit, interest, start token balance,
      // purchased units, points, total points, final token balance
      function renderTable(tableBody){
        const totalTableColumns = CALCULATOR_COLUMN_NAMES.length;
        
        // for each period in the treatment
        for ( let i = 0; i < PERIODS_PER_TREATMENT; i++ ) {
          const period = i+1;
          const periodIsPast = currentPeriod > period;

          let tableRow = document.createElement('tr');
          // shift i by 1 so that id matches the period
          tableRow.id = `table_row_${period}`;
          
          // for each column / key in a row
          CALCULATOR_COLUMN_NAMES.forEach((column) => {
            // use the column to grab the corresponding backend key's name
            // then use the BE keyname to grab the corresponding array
            // then use the period to grab the specific value needed for columnCell
            const backendKeyName = MAP_BACKEND_LABELS_TO_JS_VAR_LABELS[column];
            const backendArray = js_vars[backendKeyName];
            const backendArrayVal = backendArray[i];
            let columnCell = document.createElement('td');
            columnCell.innerText = backendArrayVal;
            // if both column is purchased_units and period is NOT in the past,
            // then swap columnCell's value
            if (column === 'purchased_unit' && !periodIsPast){
              columnCell = defaultPurchasedUnit.cloneNode(true);
            }
            // shift i by 1 so that id matches the period
            columnCell.id = `${column}-${period}`;
            tableRow.append(columnCell);
          });
          // append the row to the table
          tableBody.append(tableRow);
        }
      }

      assembleZerothRow(budgetingCalculatorBody);
      renderTable(budgetingCalculatorBody);
      
      // make a clone of the table body w/default values
      // used for handleResetClick
      const DEFAULT_VAL_TABLE_BODY = document.createElement('tbody');
      DEFAULT_VAL_TABLE_BODY.style = 'text-align: center;';
      DEFAULT_VAL_TABLE_BODY.id = 'table_body_clone';

      assembleZerothRow(DEFAULT_VAL_TABLE_BODY);
      renderTable(DEFAULT_VAL_TABLE_BODY);
    </script>

    <!-- here're all code which runs AFTER the rows are appended. -->
    <script>
      function miscCleanup(table){
        convertDecimalToPercent(table);
        convertSnakeCaseToUpperCase(table.rows[0]);
        // roundDownTokenBalanceAndPoints();
        
        if ( js_vars.obscure_a_column ) {
          obscureColumnStartingAtPeriod(js_vars.obscure_this_column_name_at_certain_period)
        }
      }

      // for inflation and interest rate
      function convertDecimalToPercent(table){
        let allRows = table.children;
        let allColumnTitles = allRows[1].children;
        let indexOfInterestRate = null;

        // for each row which is not the first row
        for ( let i = 1; i < allRows.length; i++ ){
          const row = allRows[i];
          const allChildren = row.children;
          for ( let j = 0; j < allChildren.length; j++ ){
            const child = allChildren[j];
            const id = child.id
            if (id.includes('inflation')){
              const readableInflation = (Number(child.innerHTML) - 1) * 100;
              child.innerHTML = `${readableInflation}%`
            } else if (id.includes('interest_rate')){
              const interestRate = child.innerHTML;
              if (interestRate < 0) {
                const readableInterestRate = Number(child.innerHTML) * 100;
                child.innerHTML = `${readableInterestRate}%`
              } else {
                const readableInterestRate = (Number(child.innerHTML) - 1) * 100;
                child.innerHTML = `${readableInterestRate}%`
              }
            }
          }
        }
      }

      function convertSnakeCaseToUpperCase(rowOfColumnTitles){
        let allColumnsInRow = rowOfColumnTitles.children;

        for ( let i = 0; i < allColumnsInRow.length; i++ ) {
          let columnName = allColumnsInRow[i].innerHTML;
          
          let upperCasedColumnName = columnName.split('_').map((singleWord)=>{
            return singleWord[0].toUpperCase()+singleWord.slice(1,singleWord.length);
          }).join(' ');

          allColumnsInRow[i].innerHTML = upperCasedColumnName
        };
      };

      // function roundDownTokenBalanceAndPoints(column){
      //   console.log('take a moment to round down all the annoying super long decimal values.')
      // }

      // // takes as input a string like "inflation,5,10"
      // // "${name of column you want obscured},{period you want to start obscuring},{obscure up to this period}"
      // // function obscureColumnStartingAtPeriod(string){
      // //   let columnAndPeriodTuple = string.split(',');

      // //   for ( let i = Number(columnAndPeriodTuple[1]); i <= Number(columnAndPeriodTuple[2]); i++ ) {
      // //     let tableDataElem = document.getElementById(`${columnAndPeriodTuple[0]}-${i}`);
      // //     tableDataElem.innerText = 'hidden';
      // //     tableDataElem.style.cssText = `background-color: silver`;
      // //   };

      // // }

      miscCleanup(budgetingCalculatorBody);
    </script>
  </div>
</div>