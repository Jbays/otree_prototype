{% load otree %}

<div class="card bg-light m-3">
  <div class="card-body">
    <h2 style="text-align: center;">
        Budgeting Calculator
    </h2>
    <br/>

    <style>
      table,
      td {
          border: 1px solid #333;
      }
      
      thead,
      tfoot {
          background-color: #333;
          color: #fff;
      }
    </style>

    <table id="myTable" style="text-align: center;">
      <tbody id="table_body">
        <tr style="background-color:chartreuse;">
          <td>Period</td>
          <td>Income (Tokens)</td>
          <td>Price per Unit</td>
          <td>Inflation</td>
          <td>Interest Rate (%)</td>
          <td>Token Balance (beginning of the period)</td>
          <td>Purchased Units</td>
          <td>Points</td>
          <td>Total Points</td>
          <td>Final Tokens Balance</td>
        </tr>
      </tbody>
    </table>

    <br/>
    <div style="text-align: center;">
      <button onClick=resetTableVals(event)>Reset values</button>
      <button style="background-color: red;" onClick=calculateTableVals(event)>Calculate</button>
    </div>

    <script>
      console.log(js_vars)
      //taking consts from js_vars
      const incomeConst = js_vars.income;
      const costPerUnitConst = js_vars.cost_per_unit;

      //just taking the keys from js_vars.pay_sequence
      const decisionMatrix = [js_vars.inflation_set,js_vars.interest_rate_set]
      const periodNumber = js_vars.player_round_number;

      //if this problem needs to scale, should figure out how to make this programmatically
      //maps the particular decision to its corresponding inflation, interest rate, and pay sequence
      function convertDecisionToMatrix(num){
        const obj = {
          0:[0,0,0],
          1:[1,1,0],
          2:[2,2,0],
          3:[0,0,1],
          4:[1,1,1],
          5:[2,2,1],
          6:[0,0,2],
          7:[1,1,2],
          8:[2,2,2]
        }
        return obj[num]        
      }

      //the index of the experiment_sequence string should change every two periods.
      function mapPeriodToIndex(num){
        //if num is odd
        if ( num % 2 === 1 ) {
          return Math.floor(num/2);
        }
        return Math.floor(num/2)-1;
      }

      const indexOfDecision = mapPeriodToIndex(periodNumber)
      //two periods per decision
      const particularDecision = Number(js_vars.experiment_sequence[indexOfDecision]);
      const decToChoiceMatrix = convertDecisionToMatrix(particularDecision);
      
      const inflationThisDecision = decisionMatrix[0][decToChoiceMatrix[0]]
      const interestRateThisDecision = decisionMatrix[1][decToChoiceMatrix[1]]
      const paySequenceThisDecision = decToChoiceMatrix[2]
      console.log('here is the experimental sequence --> particularDecision',particularDecision);
    </script>

    <script>
      function resetTableVals(event){
        event.preventDefault()
        //grab purchased units element, points, total points, and final token balance
        let startTokenBalance_ThisPeriod = Number(document.getElementById(`start-token-balance-${js_vars.player_round_number}`).innerHTML);
        let purchasedUnitsElem_ThisPeriod = document.getElementById(`purchased-unit-input-${js_vars.player_round_number}`);
        let pointsElem_ThisPeriod = document.getElementById(`points-${js_vars.player_round_number}`);
        let totalPointsElem_ThisPeriod = document.getElementById(`total-points-${js_vars.player_round_number}`);
        let finalTokenBalanceElem_ThisPeriod = document.getElementById(`final-token-balance-${js_vars.player_round_number}`);

        purchasedUnitsElem_ThisPeriod.value = '';
        pointsElem_ThisPeriod.innerHTML = 0;
        totalPointsElem_ThisPeriod.innerHTML = 0;
        finalTokenBalanceElem_ThisPeriod.innerHTML = startTokenBalance_ThisPeriod;
        
        //if period is odd, do more work!
        if ( js_vars.player_round_number % 2 === 1 ) {
          //calc player income for next period
          let income_NextPeriod = calculatePlayerIncomeByPeriod(paySequenceThisDecision,incomeConst,js_vars.player_round_number+1);
          
          //starting token balance for next period is equal to:
          //next period's income + (this period's final token balance * interest_rate )
          let startTokenBalance_NextPeriod = income_NextPeriod + (Number(finalTokenBalanceElem_ThisPeriod.innerHTML)*(1+interestRateThisDecision));

          let startTokenBalanceElem_NextPeriod = document.getElementById(`start-token-balance-${js_vars.player_round_number+1}`);
          // console.log('income_NextPeriod',income_NextPeriod);
          // console.log('startTokenBalance_NextPeriod',startTokenBalance_NextPeriod);
          let purchasedUnitsElem_NextPeriod = document.getElementById(`purchased-unit-input-${js_vars.player_round_number+1}`)
          let pointsElem_NextPeriod = document.getElementById(`points-${js_vars.player_round_number+1}`);
          let totalPointsElem_NextPeriod = document.getElementById(`total-points-${js_vars.player_round_number+1}`);
          let finalTokenBalanceElem_NextPeriod = document.getElementById(`final-token-balance-${js_vars.player_round_number+1}`);

          startTokenBalanceElem_NextPeriod.innerHTML = startTokenBalance_NextPeriod;
          purchasedUnitsElem_NextPeriod.value = '';
          pointsElem_NextPeriod.innerHTML = 0;
          totalPointsElem_NextPeriod.innerHTML = 0;
          finalTokenBalanceElem_NextPeriod.innerHTML = startTokenBalance_NextPeriod;
          
        }
        console.log('calculator values reset!')
      }

      function calculateTableVals(event){
        event.preventDefault()
        let startTokenBalance = Number(document.getElementById(`start-token-balance-${js_vars.player_round_number}`).innerText);
        let futureUnitPurchase_ThisPeriod = Number(document.getElementById(`purchased-unit-input-${js_vars.player_round_number}`).value);
        let pointsScored_ThisPeriod = calcNaturalLog(futureUnitPurchase_ThisPeriod);

        let points_ThisPeriod = document.getElementById(`points-${js_vars.player_round_number}`);
        points_ThisPeriod.innerHTML = pointsScored_ThisPeriod
        let totalPoints_ThisPeriod = document.getElementById(`total-points-${js_vars.player_round_number}`);
        totalPoints_ThisPeriod.innerHTML = pointsScored_ThisPeriod;
        let finalTokenBalance_ThisPeriod = document.getElementById(`final-token-balance-${js_vars.player_round_number}`);
        finalTokenBalance_ThisPeriod.innerHTML = startTokenBalance-(futureUnitPurchase_ThisPeriod*costPerUnitConst);

        //if period is odd, then do more work!
        if ( js_vars.player_round_number % 2 === 1 ){
          let income_NextPeriod = calculatePlayerIncomeByPeriod(paySequenceThisDecision,incomeConst,js_vars.player_round_number+1);

          //starting token balance for next period is equal to:
          //next period's income + (this period's final token balance * interest_rate )
          let startTokenBalance_NextPeriod = document.getElementById(`start-token-balance-${js_vars.player_round_number+1}`);
          startTokenBalance_NextPeriod.innerHTML = income_NextPeriod+(Number(finalTokenBalance_ThisPeriod.innerHTML)*(1+interestRateThisDecision))

          //then get purchased units from second input,
          let futureUnitPurchase_NextPeriod = Number(document.getElementById(`purchased-unit-input-${js_vars.player_round_number+1}`).value);
          let pointsScored_NextPeriod = calcNaturalLog(futureUnitPurchase_NextPeriod);
          
          let points_NextPeriod = document.getElementById(`points-${js_vars.player_round_number+1}`);
          points_NextPeriod.innerHTML = pointsScored_NextPeriod;
          
          //total points is equal to this period's total points + next period's total points!
          let totalPoints_NextPeriod = document.getElementById(`total-points-${js_vars.player_round_number+1}`);
          //rounded to the nearest two decimal places
          totalPoints_NextPeriod.innerHTML = (Number(points_ThisPeriod.innerHTML)+Number(points_NextPeriod.innerHTML)).toFixed(2);

          let finalTokenBalance_NextPeriod = document.getElementById(`final-token-balance-${js_vars.player_round_number+1}`);
          finalTokenBalance_NextPeriod.innerHTML = Number(startTokenBalance_NextPeriod.innerHTML) - (futureUnitPurchase_NextPeriod*costPerUnitConst);
          //calc points, total points, and final token balance
        }
        console.log('calculator updated!');
      }

      //returns the natural log of input num
      //rounded to two decimal places
      function calcNaturalLog(num){
        if ( num === 0 ) {
          return 0
        }
        return Number((Math.log(num)/Math.log(Math.E)).toFixed(2))
      }

      //key: pay_sequence=0 then pay upfront, 
      //     pay_sequence=1 then pay last round,
      //     pay_sequence=2, then pay half each round
      //inputs: pay sequence, income, and period
      //returns: the token balance (num) for a given period
      function calculatePlayerIncomeByPeriod(pay_sequence,income,period){
        //if pay sequence is equal split between rounds
        if ( pay_sequence === 2 ) {
          return income/2
        }
        //if period is odd
        if ( period % 2 === 1 ) {
          //pay upfront
          if ( pay_sequence === 0 ) {
            return income
          } //this is first period for pay second period
          else if ( pay_sequence === 1 ) {
            return 0
          }
        } else {
        //periods are even
          //already paid upfront
          if ( pay_sequence === 0 ) {
            return 0
          } else if ( pay_sequence === 1 ) {
            return income
          }
        }
      }

      // console.log('decToChoiceMatrix',decToChoiceMatrix);
      // console.log('inflationThisDecision',inflationThisDecision);
      // console.log('interestRateThisDecision',interestRateThisDecision);
      // console.log('paySequenceThisDecision',paySequenceThisDecision);
      
      onPageLoad(incomeConst,costPerUnitConst,inflationThisDecision,interestRateThisDecision,paySequenceThisDecision,js_vars.player_round_number);
      // onPageLoad(constantsNumberOfRounds,constantsPricePerUnit);

      function onPageLoad(income,cost_per_unit,inflation,interest_rate,pay_sequence,period){
        let myTable = document.getElementById('myTable');
        console.log('onPageLoad!')

        if ( period % 2 === 1 ) {
          oddPeriodTableSetUp(myTable,pay_sequence,period,income,cost_per_unit,inflation,interest_rate)
        } else {
          console.log('period is even')
          evenPeriodAppendToTable(myTable,pay_sequence,period,income,cost_per_unit,inflation,interest_rate);
        }

        function evenPeriodAppendToTable(table,pay_sequence,period,income,price_per_unit,inflation,interest_rate){
          console.log('evenPeriodAppendToTable called!');
        }

        //the syntax here looks terrible...
        //create various table elements, append input values to these table elements
        function oddPeriodTableSetUp(table,pay_sequence,period,income,price_per_unit,inflation,interest_rate){
          //create table elements for period, income, price per unit, inflation, interest rate, token balance,
          //purchased units, points, total points, final token balance
          let currRow = document.createElement('tr');

          let period_TableElem1 = document.createElement('td');
              period_TableElem1.innerHTML = period;

          let income_TableElem1 = document.createElement('td');
              income_TableElem1.innerHTML = income;

          let pricePerUnit_TableElem1 = document.createElement('td');
              pricePerUnit_TableElem1.innerHTML = price_per_unit;

          let inflation_TableElem1 = document.createElement('td');
              inflation_TableElem1.innerHTML = inflation;

          let interestRate_TableElem1 = document.createElement('td');
              interestRate_TableElem1.innerHTML = Number(interest_rate);

          let tokenBalance_TableElem1 = document.createElement('td');
              tokenBalance_TableElem1.id = `start-token-balance-${period}`;
              tokenBalance_TableElem1.innerHTML = Number(calculatePlayerIncomeByPeriod(pay_sequence,income,period));

          let purchasedUnits_TableElem1 = document.createElement('input');
              purchasedUnits_TableElem1.type = "number";
              purchasedUnits_TableElem1.min = 0;
              purchasedUnits_TableElem1.id = `purchased-unit-input-${period}`;
              purchasedUnits_TableElem1.style.cssText = "background-color:#ffbbff;text-align:center";

          let points_TableElem1 = document.createElement('td');
              points_TableElem1.id = `points-${period}`;
              points_TableElem1.innerHTML = 0;

          let totalPoints_TableElem1 = document.createElement('td');
              totalPoints_TableElem1.id = `total-points-${period}`;
              totalPoints_TableElem1.innerHTML = 0;

          let finalTokenBalance_TableElem1 = document.createElement('td');
              finalTokenBalance_TableElem1.id = `final-token-balance-${period}`;
              finalTokenBalance_TableElem1.innerHTML = tokenBalance_TableElem1.innerHTML

          currRow.appendChild(period_TableElem1);
          currRow.appendChild(income_TableElem1);
          currRow.appendChild(pricePerUnit_TableElem1);
          currRow.appendChild(inflation_TableElem1);
          currRow.appendChild(interestRate_TableElem1);
          currRow.appendChild(tokenBalance_TableElem1);
          currRow.appendChild(purchasedUnits_TableElem1);
          currRow.appendChild(points_TableElem1);
          currRow.appendChild(totalPoints_TableElem1);
          currRow.appendChild(finalTokenBalance_TableElem1);

          table.appendChild(currRow);

          let futureRow = document.createElement('tr');

          let period_TableElem2 = document.createElement('td');
          period_TableElem2.innerHTML = period+1;

          let income_TableElem2 = document.createElement('td');
          income_TableElem2.innerHTML = calculatePlayerIncomeByPeriod(pay_sequence,income,period+1);
          
          let pricePerUnit_TableElem2 = pricePerUnit_TableElem1.cloneNode(true);
          let inflation_TableElem2 = inflation_TableElem1.cloneNode(true);
          let interestRate_TableElem2 = interestRate_TableElem1.cloneNode(true);
          
          let tokenBalance_TableElem2 = document.createElement('td');
              tokenBalance_TableElem2.id = `start-token-balance-${period+1}`
              //start with last period's token balance + interest on that balance
              tokenBalance_TableElem2.innerHTML = Number(tokenBalance_TableElem1.innerText)*(1+interestRateThisDecision);
          
          let purchasedUnits_TableElem2 = document.createElement('input');
              purchasedUnits_TableElem2.type = "number";
              purchasedUnits_TableElem2.min = 0;
              purchasedUnits_TableElem2.id = `purchased-unit-input-${period+1}`;
              purchasedUnits_TableElem2.style.cssText = "background-color:#ffbbff;text-align:center";
          
          let points_TableElem2 = document.createElement('td');
              points_TableElem2.id = `points-${period+1}`;
              points_TableElem2.innerHTML = 0;
          
          let totalPoints_TableElem2 = document.createElement('td');
              totalPoints_TableElem2.id = `total-points-${period+1}`;
              totalPoints_TableElem2.innerHTML = 0;
          
          let finalTokenBalance_TableElem2 = document.createElement('td');
              finalTokenBalance_TableElem2.id = `final-token-balance-${period+1}`;
              finalTokenBalance_TableElem2.innerHTML = tokenBalance_TableElem1.innerText;

          futureRow.appendChild(period_TableElem2);
          futureRow.appendChild(income_TableElem2);
          futureRow.appendChild(pricePerUnit_TableElem2);
          futureRow.appendChild(inflation_TableElem2);
          futureRow.appendChild(interestRate_TableElem2);
          futureRow.appendChild(tokenBalance_TableElem2);
          futureRow.appendChild(purchasedUnits_TableElem2);
          futureRow.appendChild(points_TableElem2);
          futureRow.appendChild(totalPoints_TableElem2);
          futureRow.appendChild(finalTokenBalance_TableElem2);
          
          table.appendChild(futureRow);
        }
      }

    </script>
  </div>
</div>