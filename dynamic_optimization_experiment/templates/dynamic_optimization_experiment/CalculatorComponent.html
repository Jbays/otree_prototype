{% load otree %}

<div class="card bg-light m-3">
  <div class="card-body">
    <h3>
        Calculator
    </h3>

    <style>
      table,
      td {
          border: 1px solid #333;
      }
      
      thead,
      tfoot {
          background-color: #333;
          color: #fff;
      }
    </style>

    <div style="display: none;">
    <!-- <div> -->
        <div id="constants_income">
          {{Constants.income}}
        </div>
        <div id="constants_price_per_unit">
          {{Constants.price_per_unit}}
        </div>
        <div id="constants_interest_rate">
          {{Constants.interest_rate}}
        </div>
        <div id="constants_num_rounds">
          {{Constants.num_rounds}}
        </div>
        <div id="constants_k_payoff">
          {{Constants.k_payoff}}
        </div>


    </div>

    <table id="myTable" style="text-align: center;">
      <tbody>
          <tr style="background-color:chartreuse;">
              <td>Period</td>
              <td>Income (Tokens)</td>
              <td>Price per Unit</td>
              <td>Interest Rate (%)</td>
              <td>Token Balance (beginning of the period)</td>
              <td>Purchased Units</td>
              <td>Points</td>
              <td>AccumulatedPoints</td>
              <td>Final Tokens Balance</td>
          </tr>
      </tbody>
    </table>

    <script>
      function calculateTokenBalance(num,interest=0){
        let outputCellData = document.createElement('td');
        // console.log('calculate token balance!');
        if ( num === 1 ) {
          outputCellData.innerHTML = constantsIncome
        } else {
          let tokenBalanceFromLastRound = document.getElementById(`final-token-balance-${num-1}`);
          
          if ( tokenBalanceFromLastRound ) {
            outputCellData.innerHTML = Number(tokenBalanceFromLastRound.innerHTML)+Number(constantsIncome)+interest;
          }
          
        }
        return outputCellData;
      }

      function calculateInterestOnLastRoundsFinalTokenBalance(num){
        console.log('calculating Interest!');
        console.log('this is num>',num)

        let tokenBalanceFromLastRound = document.getElementById(`final-token-balance-${num-1}`).innerHTML;

        return tokenBalanceFromLastRound*(constantsInterestRate*.01);
      }

      function findPurchasedUnitsByPeriod(num,arr){
        let outputCellData = document.createElement('td');

        if ( arr[num-1] ){
          outputCellData.innerHTML = arr[num-1];
        }

        return outputCellData;
      }

      //calculate the points earned in a given round
      function calculatePointsEarned(unitsPurchased,constant){
        let outputCellData = document.createElement('td');
        outputCellData.innerHTML = (constant * ( unitsPurchased**0.5 )).toFixed(4);

        return outputCellData;
      }

      //calculate the total points earned up to that round
      function calculateAccumulatedPointsByPeriod(num,pointsJustEarned){
        let outputCellData = document.createElement('td');

        if ( num === 1 ) {
          outputCellData.innerText = pointsJustEarned;
        } else {
          let finalTokenBalanceFromLastRound = document.getElementById(`total-points-${num-1}`);
          outputCellData.innerHTML = (Number(finalTokenBalanceFromLastRound.innerHTML)+Number(pointsJustEarned)).toFixed(4);
        }

        return outputCellData
      }

      function calculateFinalTokenBalance(num,tokenBalance,pricePerUnit,unitsPurchased){
        let outputCellData = document.createElement('td');

        // console.log('tokenBalance',tokenBalance)
        // console.log('pricePerUnit',pricePerUnit)
        // console.log('unitsPurchased',unitsPurchased)

        if ( num === 1 ) {
          outputCellData.innerHTML = Number(tokenBalance) - Number(pricePerUnit) * Number(unitsPurchased) ;
        } else {
          outputCellData.innerHTML = Number(tokenBalance) - Number(pricePerUnit) * Number(unitsPurchased) ;
        }

        return outputCellData;
      }
      
      console.log(js_vars);
      let myTable = document.getElementById("myTable");

      //get a string (innerHTML) from a particular element, then remove all non-numerical values
      let constantsIncome = document.getElementById("constants_income").innerHTML.trim(); 
      let incomeCellData = document.createElement('td');
      incomeCellData.innerHTML = constantsIncome;

      let constantsPricePerUnit = document.getElementById("constants_price_per_unit").innerHTML.trim(); 
      let pricePerUnitCellData = document.createElement('td');
      pricePerUnitCellData.innerHTML = constantsPricePerUnit;

      let constantsInterestRate = document.getElementById("constants_interest_rate").innerHTML.trim(); 
      let interestRateCellData = document.createElement('td');
      interestRateCellData.innerHTML = constantsInterestRate;

      let constantsNumberOfRounds = document.getElementById("constants_num_rounds").innerHTML.trim()

      let constantsKPayoff = document.getElementById("constants_k_payoff").innerHTML.trim()

      //let's change the approach

      //first step is populate table with rounds that've already happened
      //then populate with rounds that haven't.

      for ( let i = 0; i < js_vars.player_round_number-1; i++ ) {
        console.log('this is i',i);
        let newRow = document.createElement('tr');
        newRow.style.cssText = "background-color:white"
        
        //period
        let period = i+1;
        let periodCellData = document.createElement('td');
        periodCellData.innerText = period;
        
        newRow.id = `row-period-${period}`

        let incomeClone = incomeCellData.cloneNode(true);
        let pricePerUnitClone = pricePerUnitCellData.cloneNode(true);
        let interestRateClone = interestRateCellData.cloneNode(true);
        
        let interestToBeAdded = (period > 1) ? calculateInterestOnLastRoundsFinalTokenBalance(period) : 0;
        
        console.log('this is our calculated interest',interestToBeAdded);

        let tokenBalanceCellData = calculateTokenBalance(period,interestToBeAdded);
        tokenBalanceCellData.id = `token-balance-${period}`

        let purchasedUnitsCellData = findPurchasedUnitsByPeriod(period,js_vars.purchased_units_across_all_rounds);
        purchasedUnitsCellData.id = `purchased-units-${period}`;

        let pointsEarnedCellData = calculatePointsEarned(purchasedUnitsCellData.innerHTML,constantsKPayoff);
        pointsEarnedCellData.id = `points-data-${period}`
        // let purchasedUnits = js_vars.purchased_units_across_all_rounds[i];

        newRow.appendChild(periodCellData);
        newRow.appendChild(incomeClone);
        newRow.appendChild(pricePerUnitClone);
        newRow.appendChild(interestRateClone)

        if ( tokenBalanceCellData ) {
          newRow.appendChild(tokenBalanceCellData);
        }

        if ( purchasedUnitsCellData ) {
          newRow.appendChild(purchasedUnitsCellData);
        }

        let accumulatedPointsCellData = calculateAccumulatedPointsByPeriod(period,pointsEarnedCellData.innerHTML);
        accumulatedPointsCellData.id = `total-points-${period}`;

        let finalTokenBalanceCellData = 
          calculateFinalTokenBalance(period,tokenBalanceCellData.innerHTML,constantsPricePerUnit,purchasedUnitsCellData.innerHTML)
        finalTokenBalanceCellData.id = `final-token-balance-${period}`;


        newRow.appendChild(pointsEarnedCellData);
        newRow.appendChild(accumulatedPointsCellData);
        newRow.appendChild(finalTokenBalanceCellData);
        


        myTable.appendChild(newRow);
      }


      //for each instance of player_round, populate table:
      //  with that, price_per_unit constant, interest_rate, token balance, purchased_units, points, accumulated points, and final token balance
      //
      for ( let i = js_vars.player_round_number-1; i < constantsNumberOfRounds; i++ ) {
        let newRow = document.createElement('tr');
        newRow.style.cssText = "background-color:light-gray"

        //period
        let period = i+1;
        let periodCellData = document.createElement('td');
        periodCellData.innerText = period;

        let incomeClone = incomeCellData.cloneNode(true);
        let pricePerUnitClone = pricePerUnitCellData.cloneNode(true);
        let interestRateClone = interestRateCellData.cloneNode(true);
        let tokenBalance = calculateTokenBalance(period)

        newRow.appendChild(periodCellData);
        newRow.appendChild(incomeClone);
        newRow.appendChild(pricePerUnitClone);
        newRow.appendChild(interestRateClone)

        //append token balance
        myTable.appendChild(newRow);
      }

    
      

      


    </script>

  </div>
</div>