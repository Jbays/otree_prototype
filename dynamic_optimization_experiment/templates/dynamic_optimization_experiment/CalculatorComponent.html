{% load otree %}

<div class="card bg-light m-3">
  <div class="card-body">
    <h2 style="text-align: center;">
        Budgeting Calculator
    </h2>
    <br/>

    <style>
      table,
      td {
          border: 1px solid #333;
      }
      
      thead,
      tfoot {
          background-color: #333;
          color: #fff;
      }
    </style>

    <!-- no way this is best practice -->
    <div id="" style="display: none;">
      <div id="constants_income">
        {{Constants.income}}
      </div>
      <div id="constants_price_per_unit">
        {{Constants.price_per_unit}}
      </div>
      <div id="constants_interest_rate">
        {{Constants.interest_rate}}
      </div>
      <div id="constants_num_rounds">
        {{Constants.num_rounds}}
      </div>
      <div id="constants_k_payoff">
        {{Constants.k_payoff}}
      </div>
    </div>

    <table id="myTable" style="text-align: center;">
      <tbody id="table_body">
        <tr style="background-color:chartreuse;">
          <td>Period</td>
          <td>Income (Tokens)</td>
          <td>Price per Unit</td>
          <td>Interest Rate (%)</td>
          <td>Token Balance (beginning of the period)</td>
          <td>Purchased Units</td>
          <td>Points</td>
          <td>Total Points</td>
          <td>Final Tokens Balance</td>
        </tr>
      </tbody>
    </table>

    <br/>
    <div style="text-align: center;">
      <button onClick=resetEntireTable(event)>Reset values</button>
      <button style="background-color: red;"onClick=calcHypotheticalRow(event)>Calculate</button>
    </div>

    <script>
      // let obj =  getAllGameConstants()

      // function getAllGameConstants(){

      // }

    </script>

    <script>
      //fetch constants
      let constantsNumberOfRounds = Number(document.getElementById("constants_num_rounds").innerHTML.trim());
      let constantsKPayoff = Number(document.getElementById("constants_k_payoff").innerHTML.trim());

      let constantsIncome = Number(document.getElementById("constants_income").innerHTML.trim());
      let constantsPricePerUnit = Number(document.getElementById("constants_price_per_unit").innerHTML.trim());
      let constantsInterestRate = Number(document.getElementById("constants_interest_rate").innerHTML.trim());
      
      let lastTokenBalance = findLastTokenBalance(js_vars.player_round_number)

      //create appendable elements which'll later be cloned
      let incomeTableDataElem = document.createElement('td');
      let pricePerUnitTableDataElem = document.createElement('td');
      let interestRateTableDataElem = document.createElement('td');

      //write constants to first clones
      incomeTableDataElem.innerHTML = constantsIncome;
      pricePerUnitTableDataElem.innerHTML = constantsPricePerUnit;
      interestRateTableDataElem.innerHTML = constantsInterestRate;

      // console.log('constantsIncome',constantsIncome);
      // console.log('typeof constantsIncome',typeof constantsIncome);
      // console.log(constantsPricePerUnit);
      // console.log(constantsInterestRate);
      // console.log(constantsNumberOfRounds);
      // console.log(constantsKPayoff);

      function findLastTokenBalance(period){
        console.log('period',period);
        if ( period ===  1 )  {
          return constantsIncome;
        } else {
          let output = document.getElementById(`final-token-balance-${period-1}`).innerHTML
          console.log('output',output);
        }
      }


      function initiateTableUpdate(period){
        //fetch table, make new row to be appended. add styling.
        let budgetingCalculatorTable = document.getElementById('myTable');

        async function setUpCurrentRow(period,table){
          let currRow = document.createElement('tr');
          currRow.style.cssText  = "background-color:yellow";
          currRow.id = `row-period-${js_vars.player_round_number}`;

          //creating table elements to append
          let periodTableDataElem =  document.createElement('td');
          periodTableDataElem.innerHTML = period;
          
          let incomeClone = incomeTableDataElem.cloneNode(true);
          let pricePerUnitClone = pricePerUnitTableDataElem.cloneNode(true);
          let interestRateClone = interestRateTableDataElem.cloneNode(true);

          let tokenBalanceTableDataElem = document.createElement('td');
          //if first period, no interest.  otherwise calculate interest
          let interestToBeAdded = (period  === 1 ) ? 0 : lastTokenBalance*constantsInterestRate*01 
          tokenBalanceTableDataElem.innerHTML = lastTokenBalance + interestToBeAdded;

          //adding input for purchased units
          let purchasedUnitsInputForTable = document.createElement('input');
          purchasedUnitsInputForTable.type = "number";
          purchasedUnitsInputForTable.min = 0;
          purchasedUnitsInputForTable.id = `purchased-unit-input-${period}`;
          purchasedUnitsInputForTable.style.cssText = "background-color:#ffbbff;text-align:center";

          //appending all children to the row
          currRow.appendChild(periodTableDataElem);
          currRow.appendChild(incomeClone);
          currRow.appendChild(pricePerUnitClone);
          currRow.appendChild(interestRateClone);
          currRow.appendChild(tokenBalanceTableDataElem);
          currRow.appendChild(purchasedUnitsInputForTable);

          //creating first set of empty elements to input
          let currPointsTableDataElem = document.createElement('td');
          currPointsTableDataElem.id = `points-data-${period}`
          currPointsTableDataElem.innerHTML = 0
          
          let totalPointsTableDataElem = document.createElement('td');
          totalPointsTableDataElem.id = `total-points-${period}`
          totalPointsTableDataElem.innerHTML = 0

          let finalTokenBalanceTableDataElem = document.createElement('td');
          finalTokenBalanceTableDataElem.id = `final-token-balance-${period}`;
          finalTokenBalanceTableDataElem.innerHTML = constantsIncome;

          currRow.append(currPointsTableDataElem);
          currRow.append(totalPointsTableDataElem);
          currRow.append(finalTokenBalanceTableDataElem);

          //appending row to table
          table.appendChild(currRow)

          return [period,table];
        }

        return setUpCurrentRow(period,budgetingCalculatorTable)
          .then((arr)=>{

            // for ( let i = period+1; i < constantsNumberOfRounds+1; i++ ) {
            for ( let i = arr[0]+1; i <= 3+1; i++ ) {
              populateThenAppendFutureRows(i,arr[1]);
            }

            return console.log('table !');
          })
          .catch((err)=>{
            return console.error(`this is your err: ${err}`)            
          })
      }

      function populateThenAppendFutureRows(futurePeriod,table){
        //if this is the first round
        // let lastFinalTokenBalanceElem = (futurePeriod === 2 ) ? constantsIncome : document.getElementById(`final-token-balance-${futurePeriod-1}`).innerHTML;
        let lastFinalTokenBalance = constantsIncome;
        console.log('lastFinalTokenBalance',lastFinalTokenBalance);
        let futureRow = document.createElement('tr');

        let futurePeriodTableDataElem =  document.createElement('td');
        futurePeriodTableDataElem.innerHTML = futurePeriod;

        let incomeClone = incomeTableDataElem.cloneNode(true);
        let pricePerUnitClone = pricePerUnitTableDataElem.cloneNode(true);
        let interestRateClone = interestRateTableDataElem.cloneNode(true);

        futureRow.appendChild(futurePeriodTableDataElem);
        futureRow.appendChild(incomeClone);
        futureRow.appendChild(pricePerUnitClone);
        futureRow.appendChild(interestRateClone);
        
        table.appendChild(futureRow);
      }

      initiateTableUpdate(js_vars.player_round_number);
    </script>

    <!-- button functions -->
    <script>
      //while false, functions will try to append elements to the table
      //while true, functions will try to overwrite table data's innerHTML
      let calculateButtonWasUsed = false;

      //resets values in the row (technically as a side effect)
      function resetEntireTable(event){
        event.preventDefault();
        let currRow = document.getElementById(`row-period-${js_vars.player_round_number}`);
        // let allHypotheticals = document.getElementsByClassName('hypothetical');

        for ( let i = js_vars.player_round_number; i <= Number(constantsNumberOfRounds);  i++ ) {
          let pointsTableDataElem = document.getElementById(`points-data-${i}`)
          let totalPointsTableDataElem = document.getElementById(`total-points-${i}`)
          let finalTokensBalanceTableDataElem = document.getElementById(`final-token-balance-${i}`)
          
          if ( i < Number(constantsNumberOfRounds) ) {
            let nextBeginningTokensBalanceTableDataElem = document.getElementById(`token-balance-${i+1}`) 
            nextBeginningTokensBalanceTableDataElem.innerHTML = '';
          }

          console.log(pointsTableDataElem)
          console.log(totalPointsTableDataElem)
          console.log(finalTokensBalanceTableDataElem)
          
          pointsTableDataElem.innerHTML = '';
          finalTokensBalanceTableDataElem.innerHTML = '';
          totalPointsTableDataElem.innerHTML = '';
        }
      }

      //calculate what values should be inputted
      //then call separate function to append those values
      function calcHypotheticalRow(event){
        event.preventDefault();

        let beginningTokenBalance =(js_vars.player_round_number === 1) ? 1000 :  Number(document.getElementById(`token-balance-${js_vars.player_round_number}`).innerHTML);
        let beginningTotalPoints = (js_vars.player_round_number === 1) ? beginningTokenBalance : Number(document.getElementById(`total-points-${js_vars.player_round_number-1}`).innerHTML);
        
        let purchasedUnitInput = Number(document.getElementById(`purchased-unit-input-${js_vars.player_round_number}`).value);
        let costOfPurchase = purchasedUnitInput * constantsPricePerUnit
        let hypotheticalPointGain = calcPointGain(purchasedUnitInput,Number(constantsKPayoff))
        let hypotheticalFinalTokenBalance = beginningTokenBalance - (purchasedUnitInput*constantsPricePerUnit)
        
        return updateCurrentRow(hypotheticalPointGain,
                                  beginningTotalPoints+hypotheticalPointGain-costOfPurchase,
                                  hypotheticalFinalTokenBalance)
          .then((startUpdatingAtThisRow)=>{
            for ( let i = startUpdatingAtThisRow; i <= 4; i++ ) {
            // for ( let i = startUpdatingAtThisRow; i <= Number(constantsNumberOfRounds); i++ ) {
              updateFutureRowByPeriod(i);
            }

            calculateButtonWasUsed = true;

            return 'everything worked';

          }).catch((err)=>{
            return console.error(`this  is your err: ${err}`);
          });
      }

      async function updateFutureRowByPeriod(periodNumber){
        console.log("updateFutureRowByPeriod called");
        console.log(periodNumber)
        
        //if first period, latest final token balance is 
        let latestFinalTokenBalance = ( periodNumber === 1 ) ? constantsIncome : Number(document.getElementById(`final-token-balance-${periodNumber-1}`).innerHTML);
        console.log('lastFinalTokenBalance',lastFinalTokenBalance)
        //if first period, most recent point total is zero
        let mostRecentPointTotal = ( periodNumber === 1 ) ? 0 : Number(document.getElementById(`total-points-${periodNumber-1}`).innerHTML);
        let interestToBeAdded = Number((latestFinalTokenBalance*Number(constantsInterestRate)*.01).toFixed(2));
        let futureTokenStartingBalance =  Number((latestFinalTokenBalance+interestToBeAdded).toFixed(2))+constantsIncome;
        let futurePurchasedUnits = Number(document.getElementById(`purchased-unit-input-${periodNumber}`).value);
        let hypotheticalPointsGained = Number((calcPointGain(futurePurchasedUnits,Number(constantsKPayoff))).toFixed(2));
        let hypotheticalCostOfUnitsPurchased = futurePurchasedUnits*Number(constantsPricePerUnit);

        let currRow = document.getElementById(`row-period-${periodNumber}`);
        let futureTokenStartingBalanceTableDataElem = document.getElementById(`token-balance-${periodNumber}`);
        futureTokenStartingBalanceTableDataElem.innerHTML = futureTokenStartingBalance.toFixed(2);

        console.log("updateFutureRowByPeriod called2");

        // if ( !calculateButtonWasUsed ) {
        //   //update future token balance
        //   let futurePointsGainedTableDataElem = document.createElement('td');
        //   futurePointsGainedTableDataElem.id = `points-data-${periodNumber}`;
        //   futurePointsGainedTableDataElem.innerHTML = hypotheticalPointsGained;
          
        //   let futureTotalPointsTableDataElem = document.createElement('td');
        //   futureTotalPointsTableDataElem.id = `total-points-${periodNumber}`;
        //   futureTotalPointsTableDataElem.innerHTML = Number((mostRecentPointTotal + hypotheticalPointsGained).toFixed(2));
          
        //   let futureFinalTokensBalanceTableDataElem = document.createElement('td');
        //   futureFinalTokensBalanceTableDataElem.id = `final-token-balance-${periodNumber}`;
        //   futureFinalTokensBalanceTableDataElem.innerHTML = Number((futureTokenStartingBalance - hypotheticalCostOfUnitsPurchased).toFixed(2));

        //   currRow.appendChild(futurePointsGainedTableDataElem);
        //   currRow.appendChild(futureTotalPointsTableDataElem);
        //   currRow.appendChild(futureFinalTokensBalanceTableDataElem);
        // } else {
        //   let futurePointsGainedTableDataElem = document.getElementById(`points-data-${periodNumber}`);
        //   futurePointsGainedTableDataElem.innerHTML = hypotheticalPointsGained.toFixed(2);
          
        //   let futureTotalPointsTableDataElem = document.getElementById(`total-points-${periodNumber}`);
        //   futureTotalPointsTableDataElem.innerHTML = Number((mostRecentPointTotal + hypotheticalPointsGained).toFixed(2));
          
        //   let futureFinalTokensBalanceTableDataElem = document.getElementById(`final-token-balance-${periodNumber}`);
        //   futureFinalTokensBalanceTableDataElem.innerHTML = Number((futureTokenStartingBalance - hypotheticalCostOfUnitsPurchased).toFixed(2));
        // }
      }

      //appends input values to current row
      // these points, total points, and final token balance 
      async function updateCurrentRow(pointsScored,totalPoints,finalTokenBalance){
        let currRow = document.getElementById(`row-period-${js_vars.player_round_number}`);
        let  pointsTableDataElem = document.getElementById(`points-data-${js_vars.player_round_number}`)
        let  totalPointsTableDataElem = document.getElementById(`total-points-${js_vars.player_round_number}`)
        let  finalTokenBalanceTableDataElem = document.getElementById(`final-token-balance-${js_vars.player_round_number}`)

        finalTokenBalanceTableDataElem.innerHTML = finalTokenBalance.toFixed(2);
        pointsTableDataElem.innerHTML = pointsScored.toFixed(2);
        totalPointsTableDataElem.innerHTML = totalPoints.toFixed(2);
        
        return js_vars.player_round_number+1;
      }

      //here is the function used to calculate points gained from units of output
      function calcPointGain(output,kPayoffConstant){
        return (kPayoffConstant*(output**2))+5 
      }

    </script>

  </div>
</div>