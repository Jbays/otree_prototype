{% load otree %}

<div class="card bg-light m-3">
  <div class="card-body decision-box" style="padding-bottom: 20px;">
    <div class="titleContainer">
      <div class="flexContainer">
        <div class="titleDash"></div>
        <div class="title">
          Budgeting Calculator
        </div>
      </div>
    </div>

    <style>
      button {
        min-width: 120px;
      }

      table,
      td {
        border: 1px solid #272d38;
      }

      tr:nth-child(even) {
        background-color: #343c4a;
      }

      thead,
      tfoot {
        background-color: #272d38;
        color: #fff;
      }

      .m-3 {
        margin: 1.5rem 0 0 0 !important
      }

      .red-button:hover {
        box-shadow: 0px 0px 0px 3px rgba(96, 255, 95, 0.3) !important;
      }

      #myTable {
        text-align: center;
        margin: 0 auto 1.25rem auto;
        width: 100%;
      }
    </style>

    <table id="myTable">
      <tbody style="text-align: center;" id="table_body">
      </tbody>
    </table>

    <div style="text-align: center;">
      <button class="red-button" style="background-color: white !important; color: #23272f !important; border-color: white !important;" onClick=handleResetClick(event)>
        Reset Values
      </button>
      <button onClick=handleCalculateClick(event)>Calculate</button>
    </div>

    <div id="total_number_of_periods_container" style="display:none">{{Constants.num_rounds}}</div>

    <!-- handles collecting all inputs made to calculator -->
    <script>
      // let allInputsMadeInCalculator = document.getElementById('id_all_inputs_made_in_calculator');
      // allInputsMadeInCalculator.value = "-";
    </script>

    <!-- helper functions to simplify building the table -->
    <script>

      function keyNameExtractor(arrayOfObjs) {
        let output = []
        arrayOfObjs.forEach((elem) => {
          if (elem.hasOwnProperty('name_of_field')) {
            output.push(elem.name_of_field);
          }
        })
        return output
      }

      function startValueExtractor(arrayOfObjs) {
        let output = []
        arrayOfObjs.forEach((elem) => {
          if (elem.hasOwnProperty('start_val')) {
            if (elem.start_val !== 'look-up' && elem.start_val !== 'input'){
              output.push(elem.start_val);
            } else {
              output.push(null);
            }
          } else {
            output.push(null);
          }
        })
        return output
      }
    </script>

    <!-- calculator methods -->
    <script>
      let resetTableNeeded = false;
      function handleCalculateClick(event){
        event.preventDefault();
        let purchasedUnitsInput = document.getElementById(`purchased_units-${js_vars.current_period}`);
        const unitsToBePurchased = purchasedUnitsInput.value;
        console.log('unitsToBePurchased',unitsToBePurchased);
      }

      function handleResetClick(event){
        event.preventDefault();
        console.log('handlereset click');
        console.log('js_vars.current_period',js_vars.current_period);
        let purchasedUnitsInput = document.getElementById(`purchased_units-${js_vars.current_period}`);
        purchasedUnitsInput.value = '';
        
        // let finalTokenBalanceElemFirstPeriod = document.getElementById(`final_token_balance-${js_vars.current_period}`);
        // finalTokenBalanceElemFirstPeriod.innerText = startTokenBalanceElemFirstPeriod.innerText;
      }
    </script>

    <script>
      console.log('js_vars', js_vars);

      const MAP_BACKEND_LABELS_TO_JS_VAR_LABELS = {
        period: js_vars.current_period,
        income: js_vars.income,
        inflation: js_vars.inflation,
        interest_rate: js_vars.interest_rate,
        cost_per_unit: js_vars.cost_per_unit,
        interest_rate: js_vars.interest_rate,
        start_token_balance: js_vars.start_token_balance,
        // purchased_units,
        // points,
        // total_points,
        // final_token_balance
      }

      let budgetingCalculator = document.getElementById('myTable');
      let isFirstPeriodInTreatment = js_vars.current_period % 2 === 1;
      let isSecondPeriod = js_vars.current_period % 2 === 0;
      let isThirdPeriod = js_vars.current_period % 3 === 0;
      let calculatorConfig = js_vars.the_calculator_config;

      let defaultPurchasedUnit = document.createElement('input');
      defaultPurchasedUnit.type = "number";
      defaultPurchasedUnit.step = "any";
      defaultPurchasedUnit.min = 0;
      defaultPurchasedUnit.style.cssText = "text-align: center; width: 100%; border-radius: 0 !important; border-bottom: 1px solid #23272f !important;";

      const arrayOfKeynames = keyNameExtractor(calculatorConfig[0]);
      const arrayOfStartValues = startValueExtractor(calculatorConfig[0]);
      // console.log('arrayOfStartValues',arrayOfStartValues);

      // assembles column labels and appends to table
      function assembleZerothRow(table,allKeynames){
        let columnLabelRow = document.createElement('tr');
        columnLabelRow.id = 'table_row_0';
        allKeynames.forEach((keyname) => {
          const columnLabel = document.createElement('td');
          columnLabel.id = `${keyname}-0`;
          columnLabel.innerText = keyname;
          columnLabelRow.append(columnLabel);
        })
        table.append(columnLabelRow);
      }

      // assembles values for first period && appends to table
      // if first period, then shorten logic
      // else if second or third period, then this logic is just "get values from js_vars && populate table row"
      function assembleFirstRow(table,allStartValues) {
        let firstPeriodRow = document.createElement('tr');
        const stoppingPoint = isFirstPeriodInTreatment ? 4 : allStartValues.length;
        for (let i = 0; i <= stoppingPoint; i++) {
          const startVal = allStartValues[i];
          const firstPeriodName = arrayOfKeynames[i];
          let firstPeriodData = document.createElement('td');
          firstPeriodData.id = `${firstPeriodName}-1`;
          if (startVal === null) {
            const newStartVal = MAP_BACKEND_LABELS_TO_JS_VAR_LABELS[firstPeriodName];
            firstPeriodData.innerText = newStartVal;
          } else {
            firstPeriodData.innerText = startVal;
          }
          firstPeriodRow.append(firstPeriodData);
        }
        // this part of the logic is suspicious / smelly
        if (isFirstPeriodInTreatment) {
          const specialCases = ['purchased_units', 'points', 'total_points', 'final_token_balance'];
          specialCases.forEach((columnName) => {
            let tableDataElem = document.createElement('td');
            tableDataElem.id = `${columnName}-input-${1}`;
            // if purchased_units or final token balance, then put input
            if (columnName === 'purchased_units'){
              tableDataElem = defaultPurchasedUnit.cloneNode(true);
              tableDataElem.id = `purchased_units-1`;
            } else if (columnName === 'points') {
              tableDataElem.innerText = 0;
            } 
            // for now lets set to zero BUT should add the total points up to now
            else if (columnName === 'total_points') {
              tableDataElem.innerText = 0;
            }
            // final token balance also might need some tweaking to get its starting value to behave as expected
            else if (columnName === 'final_token_balance') {
              tableDataElem.innerText = MAP_BACKEND_LABELS_TO_JS_VAR_LABELS.start_token_balance;
            }
            firstPeriodRow.append(tableDataElem);
          })
        }
        table.append(firstPeriodRow);
      }

      function assembleSecondRow(table) {

      }
      
      // console.log('budgetingCalculator',budgetingCalculator);
      // console.log('calculatorConfig', calculatorConfig);
      // console.log('isFirstPeriodInTreatment',isFirstPeriodInTreatment);
      assembleZerothRow(budgetingCalculator, arrayOfKeynames);
      assembleFirstRow(budgetingCalculator, arrayOfStartValues);
      // assembleSecondRow(budgetingCalculator, arrayOfKeynames);
      // assembleThirdRow(budgetingCalculator, arrayOfKeynames);

      // function assembleThreePeriodCalculator(table,configArrays,whichPeriod){
      // }

      // assembleThreePeriodCalculator(budgetingCalculator, calculatorConfig, isFirstPeriodInTreatment);
      // function assembleTwoPeriodCalculator(table,configArrays,firstPeriodBool){
      //   let columnLabelRow = document.createElement('tr');
      //   columnLabelRow.id = 'table_row_0';
      //   let firstPeriodRow = document.createElement('tr');
      //   firstPeriodRow.id = 'table_row_1';
      //   let secondPeriodRow = document.createElement('tr');
      //   secondPeriodRow.id = 'table_row_2';
        
      //   console.log('configArrays[0]',configArrays[0]);
      //   for ( let i = 0; i < configArrays[0].length; i++ ) {
      //     console.log('configArrays[0][i]',configArrays[0][i]);
      //     let columnTableData = document.createElement('td');
      //     let firstPeriodColumnTableData = document.createElement('td');
      //     let secondPeriodColumnTableData = document.createElement('td');
          
      //     let columnLabel = configArrays[0][i]?.name_of_field;
      //     console.log('columnLabel',columnLabel);
          
      //     firstPeriodColumnTableData.id = `${columnLabel}-1`;
      //     secondPeriodColumnTableData.id = `${columnLabel}-2`;

      //     let firstColumnData = configArrays[i][1];
      //     let secondColumnData = configArrays[i][2];
          
      //     columnTableData.innerText = columnLabel;

      //     if ( firstColumnData !== 'input' ){
      //       firstPeriodColumnTableData.innerText = configArrays[i][1];
      //     } else {
      //       let inputClone = defaultPurchasedUnit.cloneNode(true);
      //       inputClone.id = `${columnLabel}-1`;
      //       firstPeriodColumnTableData = inputClone;
      //     };
          
      //     if ( secondColumnData !== 'input' ){
      //       secondPeriodColumnTableData.innerText = configArrays[i][2];
      //     } else {
      //       let inputClone = defaultPurchasedUnit.cloneNode(true);
      //       inputClone.id = `${columnLabel}-2`;
      //       secondPeriodColumnTableData = inputClone;
      //     };

      //     columnLabelRow.append(columnTableData);
      //     firstPeriodRow.append(firstPeriodColumnTableData);
      //     secondPeriodRow.append(secondPeriodColumnTableData);
      //   };

      //   table.append(columnLabelRow);
      //   table.append(firstPeriodRow);
      //   table.append(secondPeriodRow);
      // };
      // assembleTwoPeriodCalculator(budgetingCalculator, calculatorConfig, isFirstPeriodInTreatment);

      // let resetTableNeeded = false;

      // function calculateTableVals(event){
      //   console.log('calculate called!')
      //   event.preventDefault();

      //   let costPerUnit = js_vars.cost_per_unit_this_period;
      //   let interestRate = js_vars.interest_rate;

      //   if ( resetTableNeeded ) {
      //     console.log('you should reset the table before calculating!')
      //     resetTableVals(event);
      //   }

      //   let totalPointsFirstPeriodElem = document.getElementById('total_points-1');
        
      //   let startTokenBalanceSecondPeriodElem = document.getElementById('start_token_balance-2');
      //   let startTokenBalanceSecondPeriod = Number(startTokenBalanceSecondPeriodElem.innerText);

      //   let purchasedUnitSecondPeriodElem = document.getElementById('purchased_units-2');
      //   let purchasedUnitSecondPeriod = Number(purchasedUnitSecondPeriodElem.value);

      //   appendStringToOutputString(allInputsMadeInCalculator,2,purchasedUnitSecondPeriod);

      //   let pointsSecondPeriodElem = document.getElementById('points-2');
      //   let totalPointsSecondPeriodElem = document.getElementById('total_points-2');

      //   let finalTokenBalanceSecondPeriodElem = document.getElementById('final_token_balance-2');
      //   let finalTokenBalanceSecondPeriod = Number(finalTokenBalanceSecondPeriodElem.innerText);

      //   let pointsScoredFirstPeriod;

      //   if ( isFirstPeriodInTreatment ){
      //     let startTokenBalanceFirstPeriodElem = document.getElementById('start_token_balance-1');
      //     let startTokenBalanceFirstPeriod = Number(startTokenBalanceFirstPeriodElem.innerText);

      //     let purchasedUnitFirstPeriodElem = document.getElementById('purchased_units-1');
      //     let purchasedUnitFirstPeriod = Number(purchasedUnitFirstPeriodElem.value);

      //     appendStringToOutputString(allInputsMadeInCalculator,1,purchasedUnitFirstPeriod);
          
      //     pointsScoredFirstPeriod = Number((calculateNaturalLogVals(purchasedUnitFirstPeriod)).toFixed(2));
          
      //     let pointsFirstPeriodElem = document.getElementById('points-1');
      //     let totalPointsFirstPeriodElem = document.getElementById('total_points-1');

      //     pointsFirstPeriodElem.innerText = pointsScoredFirstPeriod;
      //     totalPointsFirstPeriodElem.innerText = pointsScoredFirstPeriod;
          
      //     let totalCostFirstPeriod = costPerUnit * purchasedUnitFirstPeriod;

      //     let finalTokenBalanceFirstPeriodElem = document.getElementById('final_token_balance-1');
      //     let finalTokenBalanceFirstPeriod = Number(finalTokenBalanceFirstPeriodElem.innerText);

      //     finalTokenBalanceFirstPeriodElem.innerText = finalTokenBalanceFirstPeriod - totalCostFirstPeriod;

      //     let secondPeriodIncomeElem = document.getElementById('income-2');
      //     let secondPeriodIncome = Number(secondPeriodIncomeElem.innerText)
      //     startTokenBalanceSecondPeriodElem.innerText = (Number(finalTokenBalanceFirstPeriodElem.innerText) + secondPeriodIncome) * interestRate;
      //   }

      //   let totalCostSecondPeriod = costPerUnit * purchasedUnitSecondPeriod;
      //   let pointsScoredSecondPeriod = Number((calculateNaturalLogVals(purchasedUnitSecondPeriod)).toFixed(2));

      //   pointsSecondPeriodElem.innerText = pointsScoredSecondPeriod;

      //   totalPointsSecondPeriodElem.innerText = (Number(totalPointsFirstPeriodElem.innerText) + pointsScoredSecondPeriod).toFixed(2);
      //   finalTokenBalanceSecondPeriodElem.innerText = Number(startTokenBalanceSecondPeriodElem.innerText) - totalCostSecondPeriod;

      //   function appendStringToOutputString(input,period,number){
      //     if ( input.value === '-' ){
      //       if ( period === 1 ) {
      //         input.value = `${number};` + input.value;
      //       } else {
      //         input.value = input.value + `${number};`
      //       }
      //     } else {
      //       let splitOnDash = input.value.split('-');
            
      //       if ( period === 1 ) {
      //         splitOnDash[0] += `${number};`; 
      //       } else {
      //         splitOnDash[1] += `${number};`;
      //       }
      //       input.value = splitOnDash.join('-');
      //     }
      //   }
      //   resetTableNeeded = true;
      // }

      // function resetTableVals(event){
      //   console.log('reset table values');
      //   event.preventDefault();

      //   // if its the first period, grab the start token balance,
      //   // and reset purchased units, points, total points, 
      //   // and set final token balance equal to start token balance

      //   // high-level
      //   // the reset table vals function logic is as follows:
      //   // determine the period
      //   // reset the current period
      //   // then reset the rows for all future periods

      //   if ( js_vars.current_period_is_odd ) {
      //     let startTokenBalanceElemFirstPeriod = document.getElementById('start_token_balance-1');
          
      //     let purchasedUnitsInputFirstPeriod = document.getElementById('purchased_units-1');
      //     // purchasedUnitsInputFirstPeriod.value = "";
          
      //     let pointsElemFirstPeriod = document.getElementById('points-1');
      //     pointsElemFirstPeriod.innerText = 0;

      //     let totalPointsElemFirstPeriod = document.getElementById('total_points-1');
      //     totalPointsElemFirstPeriod.innerText = 0;

      //     let finalTokenBalanceElemFirstPeriod = document.getElementById('final_token_balance-1');
      //     finalTokenBalanceElemFirstPeriod.innerText = startTokenBalanceElemFirstPeriod.innerText;

      //     let secondPeriodIncomeElem = document.getElementById('income-2');
      //     let secondPeriodIncome = Number(secondPeriodIncomeElem.innerText);

      //     let startTokenBalanceElemSecondPeriod = document.getElementById('start_token_balance-2');
      //     startTokenBalanceElemSecondPeriod.innerText = Number(finalTokenBalanceElemFirstPeriod.innerText) + secondPeriodIncome;

      //     let purchasedUnitsInputSecondPeriod = document.getElementById('purchased_units-2');
      //     // purchasedUnitsInputSecondPeriod.value = "";

      //     let pointsElemSecondPeriod = document.getElementById('points-2');
      //     pointsElemSecondPeriod.innerText = 0;

      //     let totalPointsElemSecondPeriod = document.getElementById('total_points-2');
      //     totalPointsElemSecondPeriod.innerText = 0;

      //     let finalTokenBalanceElemSecondPeriod = document.getElementById('final_token_balance-2');
      //     finalTokenBalanceElemSecondPeriod.innerText = startTokenBalanceElemSecondPeriod.innerText;
          
      //   } else {
      //     //from previous period, final token balance and total points
      //     let finalTokenBalanceElemFirstPeriod = document.getElementById('final_token_balance-1');
      //     let totalPointsElemFirstPeriod = document.getElementById('total_points-1');

      //     let secondPeriodIncomeElem = document.getElementById('income-2');
      //     let secondPeriodIncome = Number(secondPeriodIncomeElem.innerText);

      //     let startTokenBalanceElemSecondPeriod = document.getElementById('start_token_balance-2');
      //     startTokenBalanceElemSecondPeriod.innerText = Number(finalTokenBalanceElemFirstPeriod.innerText) + secondPeriodIncome;

      //     let purchasedUnitsInputSecondPeriod = document.getElementById('purchased_units-2');
      //     // purchasedUnitsInputSecondPeriod.value = "";

      //     let pointsElemSecondPeriod = document.getElementById('points-2');
      //     pointsElemSecondPeriod.innerText = 0;

      //     let totalPointsElemSecondPeriod = document.getElementById('total_points-2');
      //     totalPointsElemSecondPeriod.innerText = totalPointsElemFirstPeriod.innerText;

      //     let finalTokenBalanceElemSecondPeriod = document.getElementById('final_token_balance-2');
      //     finalTokenBalanceElemSecondPeriod.innerText = startTokenBalanceElemSecondPeriod.innerText;
      //   }
      // };
    </script>

    <script>
      function calculateNaturalLogVals(num){
        if ( num <= 1 ) {
          return 0
        }
        return  Math.log(num) /Math.log(Math.E);
      }
    </script>

    <!-- here're all code which runs AFTER the rows are appended. -->
    <script>
      // function miscCleanup(table){
      //   convertDecimalToPercentInterestRates(table);
      //   convertSnakeCaseToUpperCase(table.rows[0]);
      //   roundDownTokenBalanceAndPoints();

        
      //   if ( js_vars.obscure_a_column ) {
      //     obscureColumnStartingAtPeriod(js_vars.obscure_this_column_name_at_certain_period)
      //   }
      // }

      // function convertDecimalToPercentInterestRates(table){
      //   let allRows = table.children;
      //   let allColumnTitles = allRows[1].children;
      //   let indexOfInterestRate = null;

      //   for ( let i = 0; i < allColumnTitles.length; i++ ) {
      //     if ( allColumnTitles[i].innerHTML === 'interest_rate' ){
      //       indexOfInterestRate = i;
      //     };
      //   }

      //   if ( indexOfInterestRate !== null ){
      //     for ( let i = 2; i < allRows.length; i++ ) {
      //       let allColumnDataByPeriod = allRows[i].children;
      //       let interestRate = Number(allColumnDataByPeriod[indexOfInterestRate].innerHTML)

      //       if ( interestRate < 0 ) {
      //         allColumnDataByPeriod[indexOfInterestRate].innerHTML = "-20%"
      //       } else {
      //         allColumnDataByPeriod[indexOfInterestRate].innerHTML = "0%"
      //       }
      //     }
      //   }
      // }

      // function convertSnakeCaseToUpperCase(rowOfColumnTitles){
      //   let allColumnsInRow = rowOfColumnTitles.children;

      //   for ( let i = 0; i < allColumnsInRow.length; i++ ) {
      //     let columnName = allColumnsInRow[i].innerHTML;
          
      //     let upperCasedColumnName = columnName.split('_').map((singleWord)=>{
      //       return singleWord[0].toUpperCase()+singleWord.slice(1,singleWord.length);
      //     }).join(' ');

      //     allColumnsInRow[i].innerHTML = upperCasedColumnName
      //   };
      // };

      // function roundDownTokenBalanceAndPoints(column){
      //   console.log('take a moment to round down all the annoying super long decimal values.')
      // }

      // // takes as input a string like "inflation,5,10"
      // // "${name of column you want obscured},{period you want to start obscuring},{obscure up to this period}"
      // // function obscureColumnStartingAtPeriod(string){
      // //   let columnAndPeriodTuple = string.split(',');

      // //   for ( let i = Number(columnAndPeriodTuple[1]); i <= Number(columnAndPeriodTuple[2]); i++ ) {
      // //     let tableDataElem = document.getElementById(`${columnAndPeriodTuple[0]}-${i}`);
      // //     tableDataElem.innerText = 'hidden';
      // //     tableDataElem.style.cssText = `background-color: silver`;
      // //   };

      // // }

      // miscCleanup(budgetingCalculator);
    
    </script>
  </div>
</div>